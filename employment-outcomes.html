<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Employment Outcomes for Recent Graduates | Law School Outcomes</title>

    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script src="http://code.highcharts.com/modules/exporting.js"></script>
  </head>
  <body>
    <h1><a href="index.html">Law School Outcomes</a></h1>
    <h2>Employment Outcomes for Recent Graduates</h2>

    <div id="my-container">
    </div>

    <footer>
      <p>
        <a href="https://data-creative.github.io/law-school-outcomes-dataviz/">view</a> |
        <a href="https://github.com/data-creative/law-school-outcomes-dataviz/">source</a> |
        <a href="https://raw.githubusercontent.com/data-creative/law-school-outcomes-dataviz/master/data/2015/employment_summary_reports.json">data</a>
      </p>
    </footer>

    <script src="http://d3js.org/colorbrewer.v1.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript" src="assets/js/employment_summary_report.js"></script>
    <script type="text/javascript">

      function updateChart() {

        //
        // REQUEST DATA FROM NEARBY JSON FILE
        //

        var year = 2015
        var url = `data/${year}/employment_summary_reports.json`

        d3.json(url, function(json){
          var reports = json

          //
          // PROCESS AND TRANSFORM RAW DATA
          //

          sortedReports = reports.sort(function(a, b){
            return d3.ascending(a.school_name, b.school_name )
          })

          // PROCESS EMPLOYMENT STATUSES

          // Returns the sum of an array of counts matching any status included in the given list
          // @param [Object] rpt
          // @param [Array] statuses
          function sumOfStatusCounts(rpt, statuses) {
            var report = new EmploymentSummaryReport(rpt)
            var counts = report.statusCounts(statuses)
            return d3.sum(counts)
          }

          var sortedEmployedCounts = sortedReports.map(function(rpt){
            return sumOfStatusCounts(rpt, EmploymentSummaryReport.employedStatuses())
          })

          var sortedUnemployedCounts = sortedReports.map(function(rpt){
            return sumOfStatusCounts(rpt, EmploymentSummaryReport.unemployedStatuses())
          })

          // PROCESS EMPLOYMENT TYPES

          // Returns a sorted series of numbers, each representing the sum of counts for all employment types belonging to the given display group.
          // @param [String] displayGroup e.g. "Law Firm (Big)"
          function sortedEmploymentTypeSeries(displayGroup) {
            var types = EmploymentSummaryReport.employmentTypes().filter(function(obj){ return obj.defaultDisplayGroup == displayGroup }).map(function(obj){ return obj.type })

            return sortedReports.map(function(rpt){ return sumOfTypeCounts(rpt, types) })
          }

          // Returns the sum of an array of counts matching any type included in the given list
          // @param [Object] rpt
          // @param [Array] types
          function sumOfTypeCounts(rpt, types) {
            var report = new EmploymentSummaryReport(rpt)
            var counts = report.typeCounts(types)
            return d3.sum(counts)
          }

          //
          // COMPILE CHART
          //

          var chartCategories = sortedReports.map(function(rpt){ return rpt.school_name.toUpperCase() })

          var chartSeries = [
            {
              name: 'Unemployed',
              color: colorbrewer.Reds[9][6],
              data: sortedUnemployedCounts // [5, 3, 4, 7, 2] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
            },
            //{
            //  name: 'Employed',
            //  color: colorbrewer.Greens[9][6],
            //  data: sortedEmployedCounts // [2, 2, 3, 2, 1] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
            //}
            {
              name: 'Employed (Other)',
              color: colorbrewer.Greys[9][6],
              data: sortedEmploymentTypeSeries('Employed (Other)') // [5, 3, 4, 7, 2] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
            },



            {
              name: "Public Interest",
              color: colorbrewer.Oranges[9][4],
              data: sortedEmploymentTypeSeries("Public Interest") // [5, 3, 4, 7, 2] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
            },

            {
              name: 'Government',
              color: colorbrewer.Oranges[9][6],
              data: sortedEmploymentTypeSeries('Government') // [5, 3, 4, 7, 2] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
            },




            {
              name: 'Clerkship',
              color: colorbrewer.Purples[9][6],
              data: sortedEmploymentTypeSeries('Clerkship') // [5, 3, 4, 7, 2] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
            },


            {
              name: 'Business & Industry',
              color: colorbrewer.Blues[9][6],
              data: sortedEmploymentTypeSeries('Business & Industry') // [5, 3, 4, 7, 2] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
            },


            {
              name: 'Law Firm (Other)',
              color: colorbrewer.Greens[9][4],
              data: sortedEmploymentTypeSeries('Law Firm (Other)') // [5, 3, 4, 7, 2] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
            },
            {
              name: 'Law Firm (Big)',
              color: colorbrewer.Greens[9][6],
              data: sortedEmploymentTypeSeries('Law Firm (Big)') // [5, 3, 4, 7, 2] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
            },
          ]

          function report(schoolShortName) {
            return sortedReports.find(function(rpt){ return rpt.school_name.toUpperCase() == schoolShortName })
          }

          function totalGrads(schoolShortName) {
            var rpt = report(schoolShortName)
            return rpt.total_grads;
          }

          function customTooltip(point) {
            var tooltip = ''
            var headerFormat = `<b>${point.x.toUpperCase()}</b><br/>`
            headerFormat += `<b>Total Grads: ${totalGrads(point.x)}</b><br/>`
            tooltip += headerFormat

            point.points.forEach(function(pt){
              var pointFormat = `<span style="color:${pt.series.color}">${pt.series.name}</span>: <b>${pt.y}</b> (${  Highcharts.numberFormat(pt.percentage, 0)  }%)<br/>`
              tooltip += pointFormat
            })

            return tooltip
          }

          //var chartSeries = [
          //    {
          //      name: 'Unemployed',
          //      data: [
          //        {name:'School A', y:5},
          //        {name:'School B', y:3},
          //        {name:'School C', y:4},
          //        {name:'School D', y:7},
          //        {name:'School E', y:2},
          //      ]
          //    },
          //    {
          //      name: 'Public Interest',
          //      data: [
          //        {name:'School A', y:2},
          //        {name:'School B', y:2},
          //        {name:'School C', y:3},
          //        {name:'School D', y:2},
          //        {name:'School E', y:1},
          //      ]
          //    },
          //    {
          //      name: 'Big Law',
          //      data: [
          //        {name:'School A', y:3},
          //        {name:'School B', y:4},
          //        {name:'School C', y:4},
          //        {name:'School D', y:2},
          //        {name:'School E', y:5},
          //      ]
          //    }
          //]

          //
          // ... OR ...
          //

          // var chartCategories = ['School A', 'School B', 'School C', 'School D', 'School E']
          //
          // var chartSeries = [
          //   {
          //     name: 'Unemployed',
          //     data: [5, 3, 4, 7, 2] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
          //   },
          //   {
          //     name: 'Public Interest',
          //     data: [2, 2, 3, 2, 1] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
          //   },
          //   {
          //     name: 'Big Law',
          //     data: [3, 4, 4, 2, 5] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
          //   }
          // ]

          var chartOptions = {
            chart: {
              type: 'column',
              marginBottom:50 // make room to display the subtitle below the chart.
            },
            exporting:{
              enabled:false,
              buttons: {contextButton: {text: 'Export'}}
            },
            credits: {enabled: false},
            legend:{
              align:'right',
              layout:'vertical',
              verticalAlign:'middle'
            },
            title: {text: 'Employment Outcomes by Law School'},
            subtitle: {
              text: 'Copyright 2017 Data Creative (http://data-creative.info). Does not distinguish between short-term/long-term or full-time/part-time employment. Law firm size considered "Big" if greater than or equal to 100 employees.',
              align:'left',
              verticalAlign:'bottom',
              floating:true,
              y: -5,
              style: { "font-size":10, "font-style":"italic" }
            },
            xAxis: {
              categories: chartCategories,
              type: "category",
              opposite:true,
              labels:{
                //formatter:function(){
                //  return `<b>${this.value}</b>`
                //},
                style: { "color": "#000", "cursor": "default", "fontSize": "11px" }
              }
            },
            yAxis: {
              min: 0,
              title: {
                text: 'PERCENTAGE OF 2015 GRADUATES',
                style: { "color": "#000", "cursor": "default", "fontSize": "11px" }
              },
              stackLabels: {enabled: true},
              labels:{
                enabled:true,
                format: '{value}%',
                style: { "color": "#000", "cursor": "default", "fontSize": "11px" }
              }
            },
            tooltip: {
              //headerFormat: '<b>{point.x}</b><br/>', // '<b>{point.key}</b><br/>'
              //pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.percentage:.0f}%)<br/>',
              formatter: function(){ return customTooltip(this) },
              shared: true,
              borderColor: '#000',
              followPointer:true,
              backgroundColor:'rgba(255,255,255, 1)' // use white background and remove opacity
            },
            plotOptions: {
              column: {
                stacking: 'percent',
                dataLabels: {
                  enabled: true,
                  format: '{point.percentage:.0f}%', // '{point.y} ({point.percentage:.0f}%)',
                  color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white'
                },
                events: {legendItemClick: function () { return false; } } // disable data-filtering functionality when series in legend is clicked
              }
            },
            series: chartSeries
          }

          myChart = Highcharts.chart('my-container', chartOptions)  // assign the Highcharts chart to the `myChart` variable to access it later via the console for debugging

        }) // d3.json()

      } // updateChart()

      updateChart()


    </script>
  </body>
</html>
