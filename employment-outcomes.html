<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Employment Outcomes for Recent Graduates | Law School Outcomes</title>

    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script src="http://code.highcharts.com/modules/exporting.js"></script>
  </head>
  <body>
    <h1><a href="index.html">Law School Outcomes</a></h1>
    <h2>Employment Outcomes for Recent Graduates</h2>

    <div id="my-container">
    </div>

    <footer>
      <p>
        <a href="https://data-creative.github.io/law-school-outcomes-dataviz/">view</a> |
        <a href="https://github.com/data-creative/law-school-outcomes-dataviz/">source</a> |
        <a href="https://raw.githubusercontent.com/data-creative/law-school-outcomes-dataviz/master/data/2015/employment_summary_reports.json">data</a>
      </p>
    </footer>

    </script>
    <script src="http://d3js.org/colorbrewer.v1.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript" src="assets/js/employment_summary_report.js"></script>
    <script type="text/javascript">

      function updateChart() {

        var year = 2015
        var url = `data/${year}/employment_summary_reports.json`

        d3.json(url, function(json){

          var reports = json.map(function(rpt){ return new EmploymentSummaryReport(rpt) })

          var sortedReports = reports.sort(function(a, b){ return d3.ascending(a.schoolShortName, b.schoolShortName ) })

          function sumOfStatusCounts(report, selectedStatuses) { return d3.sum(report.statusCounts(selectedStatuses)) }

          function sumOfTypeCounts(report, selectedTypes) { return d3.sum(report.typeCounts(selectedTypes)) }

          var chartCategories = sortedReports.map(function(rpt){ return rpt.schoolShortName })

          var selectedEmploymentTypeGroups = [
            {group: 'Employed (Other)', color: colorbrewer.Greys[9][6] },
            {group: 'Public Interest', color: colorbrewer.Oranges[9][4] },
            {group: 'Government', color: colorbrewer.Oranges[9][6] },
            {group: 'Clerkship', color: colorbrewer.Purples[9][6] },
            {group: 'Business & Industry', color: colorbrewer.Blues[9][6] },
            {group: 'Law Firm (Other)', color: colorbrewer.Greens[9][4] },
            {group: 'Law Firm (Big)', color: colorbrewer.Greens[9][6] }
          ]

          var sortedUnemployedStatusSeries = sortedReports.map(function(rpt){
            return sumOfStatusCounts(rpt, EmploymentSummaryReport.unemployedStatuses())
          })

          // Returns a sorted series of numbers, each representing the sum of counts for all employment types belonging to the given display group.
          // @param [String] displayGroup e.g. "Law Firm (Big)"
          function sortedEmploymentTypeSeries(displayGroup) {
            var types = EmploymentSummaryReport.employmentTypes().filter(function(obj){ return obj.defaultDisplayGroup == displayGroup }).map(function(obj){ return obj.type })
            return sortedReports.map(function(rpt){ return sumOfTypeCounts(rpt, types) })
          }

          function chartSeries() {
            var series = []

            series = series.concat({
              name: 'Unemployed',
              color: colorbrewer.Reds[9][6],
              data: sortedUnemployedStatusSeries // [5, 3, 4, 7, 2] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
            })

            selectedEmploymentTypeGroups.forEach(function(groupColor){
              series = series.concat({
                name: groupColor.group,
                color: groupColor.color,
                data: sortedEmploymentTypeSeries(groupColor.group) // [5, 3, 4, 7, 2] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
              })
            })

            return series
          }

          function report(schoolShortName) {
            return sortedReports.find(function(rpt){ return rpt.schoolShortName == schoolShortName })
          }

          function totalGrads(schoolShortName) {
            var rpt = report(schoolShortName)
            return rpt.totalGrads;
          }

          function customTooltip(point) {
            var tooltip = ''
            var headerFormat = `<b>${point.x.toUpperCase()}</b><br/>`
            headerFormat += `<b>Total Grads: ${totalGrads(point.x)}</b><br/>`
            tooltip += headerFormat

            point.points.forEach(function(pt){
              var pointFormat = `<span style="color:${pt.series.color}">${pt.series.name}</span>: <b>${pt.y}</b> (${  Highcharts.numberFormat(pt.percentage, 0)  }%)<br/>`
              tooltip += pointFormat
            })

            return tooltip
          }

          //var chartSeries = [
          //    {
          //      name: 'Unemployed',
          //      data: [
          //        {name:'School A', y:5},
          //        {name:'School B', y:3},
          //        {name:'School C', y:4},
          //        {name:'School D', y:7},
          //        {name:'School E', y:2},
          //      ]
          //    },
          //    {
          //      name: 'Public Interest',
          //      data: [
          //        {name:'School A', y:2},
          //        {name:'School B', y:2},
          //        {name:'School C', y:3},
          //        {name:'School D', y:2},
          //        {name:'School E', y:1},
          //      ]
          //    },
          //    {
          //      name: 'Big Law',
          //      data: [
          //        {name:'School A', y:3},
          //        {name:'School B', y:4},
          //        {name:'School C', y:4},
          //        {name:'School D', y:2},
          //        {name:'School E', y:5},
          //      ]
          //    }
          //]

          //
          // ... OR ...
          //

          // var chartCategories = ['School A', 'School B', 'School C', 'School D', 'School E']
          //
          // var chartSeries = [
          //   {
          //     name: 'Unemployed',
          //     data: [5, 3, 4, 7, 2] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
          //   },
          //   {
          //     name: 'Public Interest',
          //     data: [2, 2, 3, 2, 1] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
          //   },
          //   {
          //     name: 'Big Law',
          //     data: [3, 4, 4, 2, 5] // must be in same order as ['School A', 'School B', 'School C', 'School D', 'School E']
          //   }
          // ]

          var chartOptions = {
            chart: {
              type: 'column',
              marginBottom:50 // make room to display the subtitle below the chart.
            },
            exporting:{
              enabled:false,
              buttons: {contextButton: {text: 'Export'}}
            },
            credits: {enabled: false},
            legend:{
              align:'right',
              layout:'vertical',
              verticalAlign:'middle'
            },
            title: {text: 'Employment Outcomes by Law School'},
            subtitle: {
              text: 'Copyright 2017 Data Creative (http://data-creative.info). Does not distinguish between short-term/long-term or full-time/part-time employment. Law firm size considered "Big" if greater than or equal to 100 employees.',
              align:'left',
              verticalAlign:'bottom',
              floating:true,
              y: -5,
              style: { "font-size":10, "font-style":"italic" }
            },
            xAxis: {
              categories: chartCategories,
              type: "category",
              opposite:true,
              labels:{
                //formatter:function(){
                //  return `<b>${this.value}</b>`
                //},
                style: { "color": "#000", "cursor": "default", "fontSize": "11px" }
              }
            },
            yAxis: {
              min: 0,
              title: {
                text: `PERCENTAGE OF ${year} GRADUATES`,
                style: { "color": "#000", "cursor": "default", "fontSize": "11px" }
              },
              stackLabels: {enabled: true},
              labels:{
                enabled:true,
                format: '{value}%',
                style: { "color": "#000", "cursor": "default", "fontSize": "11px" }
              }
            },
            tooltip: {
              //headerFormat: '<b>{point.x}</b><br/>', // '<b>{point.key}</b><br/>'
              //pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.percentage:.0f}%)<br/>',
              formatter: function(){ return customTooltip(this) },
              shared: true,
              borderColor: '#000',
              followPointer:true,
              backgroundColor:'rgba(255,255,255, 1)' // use white background and remove opacity
            },
            plotOptions: {
              column: {
                stacking: 'percent',
                dataLabels: {
                  enabled: true,
                  format: '{point.percentage:.0f}%', // '{point.y} ({point.percentage:.0f}%)',
                  color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white'
                },
                events: {legendItemClick: function () { return false; } } // disable data-filtering functionality when series in legend is clicked
              }
            },
            series: chartSeries()
          }

          myChart = Highcharts.chart('my-container', chartOptions)  // assign the Highcharts chart to the `myChart` variable to access it later via the console for debugging

        }) // d3.json()

      } // updateChart()

      updateChart()


    </script>
  </body>
</html>
